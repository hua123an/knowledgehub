{"version":3,"file":"main.js","sources":["../electron/database/index.ts","../node_modules/uuid/dist-node/stringify.js","../node_modules/uuid/dist-node/rng.js","../node_modules/uuid/dist-node/native.js","../node_modules/uuid/dist-node/v4.js","../electron/constants.ts","../electron/context.ts","../electron/ipc/notes.ts","../electron/ipc/folders.ts","../electron/ipc/tags.ts","../electron/ipc/links.ts","../electron/ipc/settings.ts","../electron/ai/service.ts","../electron/ai/websearch.ts","../electron/ai/index.ts","../electron/ipc/attachments.ts","../electron/ipc/dialog.ts","../electron/ipc/index.ts","../electron/main.ts"],"sourcesContent":["import { app } from 'electron'\nimport * as path from 'path'\nimport * as fs from 'fs'\nimport { createRequire } from 'module'\n\n// 使用 createRequire 加载原生模块\nconst require = createRequire(import.meta.url)\nconst Database = require('better-sqlite3')\n\ntype DatabaseType = ReturnType<typeof Database>\nlet db: DatabaseType | null = null\n\nexport function getDatabase(): DatabaseType {\n  if (!db) {\n    throw new Error('Database not initialized')\n  }\n  return db\n}\n\nexport function initDatabase(): DatabaseType {\n  const userDataPath = app.getPath('userData')\n  const dbPath = path.join(userDataPath, 'knowledge.db')\n  \n  // 确保目录存在\n  if (!fs.existsSync(userDataPath)) {\n    fs.mkdirSync(userDataPath, { recursive: true })\n  }\n  \n  db = new Database(dbPath)\n  \n  // 启用外键约束\n  db.pragma('foreign_keys = ON')\n  \n  // 创建表结构\n  const schema = `\n    -- 笔记/文档表\n    CREATE TABLE IF NOT EXISTS notes (\n      id TEXT PRIMARY KEY,\n      title TEXT NOT NULL,\n      content TEXT DEFAULT '',\n      type TEXT CHECK(type IN ('markdown', 'bookmark', 'snippet')) NOT NULL DEFAULT 'markdown',\n      folder_id TEXT,\n      url TEXT,\n      favicon TEXT,\n      description TEXT,\n      language TEXT,\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (folder_id) REFERENCES folders(id) ON DELETE SET NULL\n    );\n\n    -- 标签表\n    CREATE TABLE IF NOT EXISTS tags (\n      id TEXT PRIMARY KEY,\n      name TEXT UNIQUE NOT NULL,\n      color TEXT DEFAULT '#409EFF'\n    );\n\n    -- 笔记-标签关联表\n    CREATE TABLE IF NOT EXISTS note_tags (\n      note_id TEXT NOT NULL,\n      tag_id TEXT NOT NULL,\n      PRIMARY KEY (note_id, tag_id),\n      FOREIGN KEY (note_id) REFERENCES notes(id) ON DELETE CASCADE,\n      FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE\n    );\n\n    -- 双向链接表\n    CREATE TABLE IF NOT EXISTS links (\n      source_id TEXT NOT NULL,\n      target_id TEXT NOT NULL,\n      PRIMARY KEY (source_id, target_id),\n      FOREIGN KEY (source_id) REFERENCES notes(id) ON DELETE CASCADE,\n      FOREIGN KEY (target_id) REFERENCES notes(id) ON DELETE CASCADE\n    );\n\n    -- 文件夹表\n    CREATE TABLE IF NOT EXISTS folders (\n      id TEXT PRIMARY KEY,\n      name TEXT NOT NULL,\n      parent_id TEXT,\n      sort_order INTEGER DEFAULT 0,\n      FOREIGN KEY (parent_id) REFERENCES folders(id) ON DELETE CASCADE\n    );\n\n    -- 设置表\n    CREATE TABLE IF NOT EXISTS settings (\n      key TEXT PRIMARY KEY,\n      value TEXT\n    );\n\n    -- 附件表\n    CREATE TABLE IF NOT EXISTS attachments (\n      id TEXT PRIMARY KEY,\n      note_id TEXT NOT NULL,\n      filename TEXT NOT NULL,\n      stored_name TEXT NOT NULL,\n      mime_type TEXT NOT NULL,\n      category TEXT CHECK(category IN ('image','audio','video','document','other')) NOT NULL,\n      size INTEGER NOT NULL DEFAULT 0,\n      width INTEGER,\n      height INTEGER,\n      duration REAL,\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (note_id) REFERENCES notes(id) ON DELETE CASCADE\n    );\n  `\n  \n  db.exec(schema)\n\n  // 为已有数据库添加新列（软删除 + 收藏）\n  try {\n    db.exec(`ALTER TABLE notes ADD COLUMN deleted_at TEXT DEFAULT NULL`)\n  } catch (e) {\n    // 列可能已存在\n  }\n  try {\n    db.exec(`ALTER TABLE notes ADD COLUMN is_starred INTEGER DEFAULT 0`)\n  } catch (e) {\n    // 列可能已存在\n  }\n\n  // 创建全文搜索表（如果不存在）\n  try {\n    db.exec(`\n      CREATE VIRTUAL TABLE IF NOT EXISTS notes_fts USING fts5(\n        title,\n        content,\n        content='notes',\n        content_rowid='rowid'\n      );\n    `)\n  } catch (e) {\n    // FTS表可能已存在\n  }\n  \n  // 创建触发器\n  try {\n    db.exec(`\n      CREATE TRIGGER IF NOT EXISTS notes_ai AFTER INSERT ON notes BEGIN\n        INSERT INTO notes_fts(rowid, title, content) VALUES (NEW.rowid, NEW.title, NEW.content);\n      END;\n    `)\n    db.exec(`\n      CREATE TRIGGER IF NOT EXISTS notes_au AFTER UPDATE ON notes BEGIN\n        INSERT INTO notes_fts(notes_fts, rowid, title, content) VALUES('delete', OLD.rowid, OLD.title, OLD.content);\n        INSERT INTO notes_fts(rowid, title, content) VALUES (NEW.rowid, NEW.title, NEW.content);\n      END;\n    `)\n    db.exec(`\n      CREATE TRIGGER IF NOT EXISTS notes_ad AFTER DELETE ON notes BEGIN\n        INSERT INTO notes_fts(notes_fts, rowid, title, content) VALUES('delete', OLD.rowid, OLD.title, OLD.content);\n      END;\n    `)\n  } catch (e) {\n    // 触发器可能已存在\n  }\n  \n  // 创建索引\n  try {\n    db.exec(`\n      CREATE INDEX IF NOT EXISTS idx_notes_folder ON notes(folder_id);\n      CREATE INDEX IF NOT EXISTS idx_notes_type ON notes(type);\n      CREATE INDEX IF NOT EXISTS idx_notes_updated ON notes(updated_at DESC);\n      CREATE INDEX IF NOT EXISTS idx_folders_parent ON folders(parent_id);\n      CREATE INDEX IF NOT EXISTS idx_note_tags_note ON note_tags(note_id);\n      CREATE INDEX IF NOT EXISTS idx_note_tags_tag ON note_tags(tag_id);\n      CREATE INDEX IF NOT EXISTS idx_links_source ON links(source_id);\n      CREATE INDEX IF NOT EXISTS idx_links_target ON links(target_id);\n      CREATE INDEX IF NOT EXISTS idx_attachments_note ON attachments(note_id);\n      CREATE INDEX IF NOT EXISTS idx_attachments_category ON attachments(category);\n    `)\n  } catch (e) {\n    // 索引可能已存在\n  }\n  \n  return db\n}\n\nexport function closeDatabase() {\n  if (db) {\n    db.close()\n    db = null\n  }\n}\n","import validate from './validate.js';\nconst byteToHex = [];\nfor (let i = 0; i < 256; ++i) {\n    byteToHex.push((i + 0x100).toString(16).slice(1));\n}\nexport function unsafeStringify(arr, offset = 0) {\n    return (byteToHex[arr[offset + 0]] +\n        byteToHex[arr[offset + 1]] +\n        byteToHex[arr[offset + 2]] +\n        byteToHex[arr[offset + 3]] +\n        '-' +\n        byteToHex[arr[offset + 4]] +\n        byteToHex[arr[offset + 5]] +\n        '-' +\n        byteToHex[arr[offset + 6]] +\n        byteToHex[arr[offset + 7]] +\n        '-' +\n        byteToHex[arr[offset + 8]] +\n        byteToHex[arr[offset + 9]] +\n        '-' +\n        byteToHex[arr[offset + 10]] +\n        byteToHex[arr[offset + 11]] +\n        byteToHex[arr[offset + 12]] +\n        byteToHex[arr[offset + 13]] +\n        byteToHex[arr[offset + 14]] +\n        byteToHex[arr[offset + 15]]).toLowerCase();\n}\nfunction stringify(arr, offset = 0) {\n    const uuid = unsafeStringify(arr, offset);\n    if (!validate(uuid)) {\n        throw TypeError('Stringified UUID is invalid');\n    }\n    return uuid;\n}\nexport default stringify;\n","import { randomFillSync } from 'node:crypto';\nconst rnds8Pool = new Uint8Array(256);\nlet poolPtr = rnds8Pool.length;\nexport default function rng() {\n    if (poolPtr > rnds8Pool.length - 16) {\n        randomFillSync(rnds8Pool);\n        poolPtr = 0;\n    }\n    return rnds8Pool.slice(poolPtr, (poolPtr += 16));\n}\n","import { randomUUID } from 'node:crypto';\nexport default { randomUUID };\n","import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\nfunction _v4(options, buf, offset) {\n    options = options || {};\n    const rnds = options.random ?? options.rng?.() ?? rng();\n    if (rnds.length < 16) {\n        throw new Error('Random bytes length must be >= 16');\n    }\n    rnds[6] = (rnds[6] & 0x0f) | 0x40;\n    rnds[8] = (rnds[8] & 0x3f) | 0x80;\n    if (buf) {\n        offset = offset || 0;\n        if (offset < 0 || offset + 16 > buf.length) {\n            throw new RangeError(`UUID byte range ${offset}:${offset + 15} is out of buffer bounds`);\n        }\n        for (let i = 0; i < 16; ++i) {\n            buf[offset + i] = rnds[i];\n        }\n        return buf;\n    }\n    return unsafeStringify(rnds);\n}\nfunction v4(options, buf, offset) {\n    if (native.randomUUID && !buf && !options) {\n        return native.randomUUID();\n    }\n    return _v4(options, buf, offset);\n}\nexport default v4;\n","// IPC 通道名称\nexport const IPC_CHANNELS = {\n  // 数据库操作\n  DB_INIT: 'db:init',\n  DB_QUERY: 'db:query',\n  DB_RUN: 'db:run',\n  \n  // 笔记操作\n  NOTE_CREATE: 'note:create',\n  NOTE_UPDATE: 'note:update',\n  NOTE_DELETE: 'note:delete',\n  NOTE_GET: 'note:get',\n  NOTE_LIST: 'note:list',\n  NOTE_SEARCH: 'note:search',\n  NOTE_RESTORE: 'note:restore',\n  NOTE_PERMANENT_DELETE: 'note:permanentDelete',\n  NOTE_TRASH_LIST: 'note:trashList',\n  NOTE_STAR: 'note:star',\n  NOTE_UNSTAR: 'note:unstar',\n  \n  // 文件夹操作\n  FOLDER_CREATE: 'folder:create',\n  FOLDER_UPDATE: 'folder:update',\n  FOLDER_DELETE: 'folder:delete',\n  FOLDER_LIST: 'folder:list',\n  \n  // 标签操作\n  TAG_CREATE: 'tag:create',\n  TAG_UPDATE: 'tag:update',\n  TAG_DELETE: 'tag:delete',\n  TAG_LIST: 'tag:list',\n  TAG_ADD_TO_NOTE: 'tag:addToNote',\n  TAG_REMOVE_FROM_NOTE: 'tag:removeFromNote',\n  \n  // 链接操作\n  LINK_CREATE: 'link:create',\n  LINK_DELETE: 'link:delete',\n  LINK_GET_BY_NOTE: 'link:getByNote',\n  LINK_GET_GRAPH: 'link:getGraph',\n  \n  // 文件操作\n  FILE_READ: 'file:read',\n  FILE_WRITE: 'file:write',\n  FILE_DELETE: 'file:delete',\n  \n  // 设置\n  SETTINGS_GET: 'settings:get',\n  SETTINGS_SET: 'settings:set',\n\n  // AI\n  AI_CHAT: 'ai:chat',\n  AI_CHAT_STREAM: 'ai:chatStream',\n  AI_STOP: 'ai:stop',\n  AI_SUMMARIZE: 'ai:summarize',\n  AI_SUGGEST_TAGS: 'ai:suggestTags',\n  AI_POLISH: 'ai:polish',\n  AI_CONTINUE: 'ai:continue',\n  AI_TRANSLATE: 'ai:translate',\n  AI_EXPLAIN: 'ai:explain',\n  AI_SEARCH_ENHANCE: 'ai:searchEnhance',\n  AI_WEB_SEARCH: 'ai:webSearch',\n  AI_CHAT_HISTORY_LIST: 'ai:chatHistoryList',\n  AI_CHAT_HISTORY_GET: 'ai:chatHistoryGet',\n  AI_CHAT_HISTORY_SAVE: 'ai:chatHistorySave',\n  AI_CHAT_HISTORY_DELETE: 'ai:chatHistoryDelete',\n  // 附件操作\n  ATTACHMENT_UPLOAD: 'attachment:upload',\n  ATTACHMENT_DELETE: 'attachment:delete',\n  ATTACHMENT_GET: 'attachment:get',\n  ATTACHMENT_LIST: 'attachment:list',\n  ATTACHMENT_GET_PATH: 'attachment:getPath',\n  ATTACHMENT_OPEN: 'attachment:open',\n  ATTACHMENT_PICK_FILE: 'attachment:pickFile',\n\n  // 系统\n  SYSTEM_REVEAL: 'system:reveal',\n} as const\n\n","// 全局上下文，用于在不同 IPC 模块间共享状态\nexport const globalContext = {\n  currentWorkspace: null as string | null\n}\n","import { ipcMain } from 'electron'\nimport * as fs from 'fs'\nimport * as path from 'path'\nimport { v4 as uuidv4 } from 'uuid'\nimport { getDatabase } from '../database'\nimport { IPC_CHANNELS } from '../constants'\nimport { globalContext } from '../context'\n\ninterface NoteRow {\n  id: string\n  title: string\n  content: string\n  type: string\n  folder_id: string | null\n  url: string | null\n  favicon: string | null\n  description: string | null\n  language: string | null\n  created_at: string\n  updated_at: string\n  deleted_at: string | null\n  is_starred: number\n}\n\nfunction rowToNote(row: NoteRow) {\n  return {\n    id: row.id,\n    title: row.title,\n    content: row.content,\n    type: row.type as 'markdown' | 'bookmark' | 'snippet',\n    folderId: row.folder_id,\n    url: row.url || undefined,\n    favicon: row.favicon || undefined,\n    description: row.description || undefined,\n    language: row.language || undefined,\n    createdAt: row.created_at,\n    updatedAt: row.updated_at,\n    deletedAt: row.deleted_at,\n    isStarred: row.is_starred === 1,\n  }\n}\n\nexport function registerNoteHandlers() {\n  const db = getDatabase()\n\n  // 创建笔记\n  ipcMain.handle(IPC_CHANNELS.NOTE_CREATE, async (_event, note) => {\n    try {\n      const id = uuidv4()\n      const now = new Date().toISOString()\n      \n      const stmt = db.prepare(`\n        INSERT INTO notes (id, title, content, type, folder_id, url, favicon, description, language, created_at, updated_at)\n        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n      `)\n      \n      stmt.run(\n        id,\n        note.title || '无标题',\n        note.content || '',\n        note.type || 'markdown',\n        note.folderId || null,\n        note.url || null,\n        note.favicon || null,\n        note.description || null,\n        note.language || null,\n        now,\n        now\n      )\n      \n      const created = db.prepare('SELECT * FROM notes WHERE id = ?').get(id) as NoteRow\n      \n      // 同步写入文件系统\n      if (globalContext.currentWorkspace) {\n         const filename = `${created.title}.md`\n         const filePath = path.join(globalContext.currentWorkspace, filename)\n         try {\n           // 确保不覆盖现有文件（虽然 uuid 保证 id 唯一，但 title 可能重复）\n           // 如果文件已存在，应该报错还是自动重命名？\n           // 目前简单处理：如果存在，覆盖（因为这是新建操作，且前端可能没有重复检查）\n           // 更好的做法是在前端检查 title 唯一性。\n           // 这里我们直接写入。\n           fs.writeFileSync(filePath, created.content || '', 'utf-8')\n           console.log('[Main] Created file:', filePath)\n         } catch (e) {\n           console.error('[Main] Create file failed:', e)\n         }\n      }\n\n      return { success: true, data: rowToNote(created) }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 更新笔记\n  ipcMain.handle(IPC_CHANNELS.NOTE_UPDATE, async (_event, id, updates) => {\n    try {\n      // Get existing note first for rename logic\n      const existing = db.prepare('SELECT * FROM notes WHERE id = ?').get(id) as NoteRow | undefined\n      if (!existing) {\n        return { success: false, error: 'Note not found' }\n      }\n\n      const fields: string[] = []\n      const values: any[] = []\n      \n      if (updates.title !== undefined) {\n        fields.push('title = ?')\n        values.push(updates.title)\n      }\n      if (updates.content !== undefined) {\n        fields.push('content = ?')\n        values.push(updates.content)\n      }\n      if (updates.folderId !== undefined) {\n        fields.push('folder_id = ?')\n        values.push(updates.folderId)\n      }\n      if (updates.url !== undefined) {\n        fields.push('url = ?')\n        values.push(updates.url)\n      }\n      if (updates.favicon !== undefined) {\n        fields.push('favicon = ?')\n        values.push(updates.favicon)\n      }\n      if (updates.description !== undefined) {\n        fields.push('description = ?')\n        values.push(updates.description)\n      }\n      if (updates.language !== undefined) {\n        fields.push('language = ?')\n        values.push(updates.language)\n      }\n      \n      fields.push('updated_at = ?')\n      values.push(new Date().toISOString())\n      values.push(id)\n      \n      const stmt = db.prepare(`UPDATE notes SET ${fields.join(', ')} WHERE id = ?`)\n      stmt.run(...values)\n      \n      const updated = db.prepare('SELECT * FROM notes WHERE id = ?').get(id) as NoteRow\n\n      // 同步写入文件系统\n      if (globalContext.currentWorkspace && updated) {\n        // 简单策略：按 title 寻找文件名\n        const filename = `${updated.title}.md`\n        const filePath = path.join(globalContext.currentWorkspace, filename)\n        \n        // 1. 如果 title 变了，先重命名旧文件\n        if (updates.title !== undefined && updates.title !== existing.title) {\n           const oldPath = path.join(globalContext.currentWorkspace, `${existing.title}.md`)\n           try {\n             if (fs.existsSync(oldPath)) {\n               fs.renameSync(oldPath, filePath)\n               console.log('[Main] Renamed file:', oldPath, '->', filePath)\n             }\n           } catch (e) {\n             console.error('[Main] Rename failed:', e)\n           }\n        }\n\n        // 2. 写入/更新内容 (如果是重命名后的文件，这里也会更新内容)\n        // 只有当更新了 content 或者 title (导致文件名变化) 时，我们才确保文件存在\n        // 但这里我们简单点：只要有 currentWorkspace，每次 update 都确保文件内容是最新的\n        // 或者是只在 content 变动时写？\n        // 如果只重命名，content 没传，我们需要读 DB 里的 content 写进去吗？\n        // renameSync 已经移动了文件内容。所以只要 content 没变，不需要重写。\n        \n        if (updates.content !== undefined) {\n           try {\n             fs.writeFileSync(filePath, updates.content, 'utf-8')\n             console.log('[Main] Saved file:', filePath)\n           } catch (e) {\n             console.error('[Main] Save failed:', e)\n           }\n        }\n      }\n\n      return { success: true, data: rowToNote(updated) }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 删除笔记（软删除 - 移入回收站）\n  ipcMain.handle(IPC_CHANNELS.NOTE_DELETE, async (_event, id) => {\n    try {\n      const now = new Date().toISOString()\n      db.prepare('UPDATE notes SET deleted_at = ? WHERE id = ?').run(now, id)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 获取单个笔记\n  ipcMain.handle(IPC_CHANNELS.NOTE_GET, async (_event, id) => {\n    try {\n      const row = db.prepare('SELECT * FROM notes WHERE id = ?').get(id) as NoteRow | undefined\n      if (row) {\n        return { success: true, data: rowToNote(row) }\n      }\n      return { success: false, error: 'Note not found' }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 获取笔记列表\n  ipcMain.handle(IPC_CHANNELS.NOTE_LIST, async (_event, filters = {}) => {\n    try {\n      let sql = 'SELECT * FROM notes WHERE deleted_at IS NULL'\n      const params: any[] = []\n\n      if (filters.type) {\n        sql += ' AND type = ?'\n        params.push(filters.type)\n      }\n      if (filters.folderId !== undefined) {\n        if (filters.folderId === null) {\n          sql += ' AND folder_id IS NULL'\n        } else {\n          sql += ' AND folder_id = ?'\n          params.push(filters.folderId)\n        }\n      }\n\n      sql += ' ORDER BY is_starred DESC, updated_at DESC'\n\n      const rows = db.prepare(sql).all(...params) as NoteRow[]\n      return { success: true, data: rows.map(rowToNote) }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 搜索笔记\n  ipcMain.handle(IPC_CHANNELS.NOTE_SEARCH, async (_event, query) => {\n    try {\n      if (!query || query.trim() === '') {\n        return { success: true, data: [] }\n      }\n      \n      const searchTerm = `%${query}%`\n      const rows = db.prepare(`\n        SELECT * FROM notes\n        WHERE (title LIKE ? OR content LIKE ?) AND deleted_at IS NULL\n        ORDER BY updated_at DESC\n        LIMIT 50\n      `).all(searchTerm, searchTerm) as NoteRow[]\n      \n      const results = rows.map(row => {\n        // 手动生成简单的摘要和高亮\n        let snippet = (row.content || '').slice(0, 150)\n        if (row.content && row.content.toLowerCase().includes(query.toLowerCase())) {\n          const idx = row.content.toLowerCase().indexOf(query.toLowerCase())\n          const start = Math.max(0, idx - 40)\n          const end = Math.min(row.content.length, idx + 80)\n          snippet = (start > 0 ? '...' : '') + row.content.slice(start, end) + (end < row.content.length ? '...' : '')\n        }\n\n        const matchField = row.title.toLowerCase().includes(query.toLowerCase()) ? '标题' : '内容'\n\n        return {\n          note: rowToNote(row),\n          matchField,\n          contentSnippet: snippet,\n          score: 0,\n        }\n      })\n      \n      return { success: true, data: results }\n    } catch (error) {\n      console.error('Search error:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 恢复笔记（从回收站恢复）\n  ipcMain.handle(IPC_CHANNELS.NOTE_RESTORE, async (_event, id) => {\n    try {\n      db.prepare('UPDATE notes SET deleted_at = NULL WHERE id = ?').run(id)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 永久删除笔记\n  ipcMain.handle(IPC_CHANNELS.NOTE_PERMANENT_DELETE, async (_event, id) => {\n    try {\n      const existing = db.prepare('SELECT * FROM notes WHERE id = ?').get(id) as NoteRow | undefined\n      if (globalContext.currentWorkspace && existing) {\n        const filePath = path.join(globalContext.currentWorkspace, `${existing.title}.md`)\n        try {\n          if (fs.existsSync(filePath)) {\n            fs.unlinkSync(filePath)\n            console.log('[Main] Permanently deleted file:', filePath)\n          }\n        } catch (e) {\n          console.error('[Main] Delete file failed:', e)\n        }\n      }\n\n      db.prepare('DELETE FROM notes WHERE id = ?').run(id)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 获取回收站列表\n  ipcMain.handle(IPC_CHANNELS.NOTE_TRASH_LIST, async () => {\n    try {\n      const rows = db.prepare(\n        'SELECT * FROM notes WHERE deleted_at IS NOT NULL ORDER BY deleted_at DESC'\n      ).all() as NoteRow[]\n      return { success: true, data: rows.map(rowToNote) }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 收藏笔记\n  ipcMain.handle(IPC_CHANNELS.NOTE_STAR, async (_event, id) => {\n    try {\n      db.prepare('UPDATE notes SET is_starred = 1 WHERE id = ?').run(id)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 取消收藏笔记\n  ipcMain.handle(IPC_CHANNELS.NOTE_UNSTAR, async (_event, id) => {\n    try {\n      db.prepare('UPDATE notes SET is_starred = 0 WHERE id = ?').run(id)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n}\n","import { ipcMain } from 'electron'\nimport { v4 as uuidv4 } from 'uuid'\nimport fs from 'node:fs'\nimport path from 'node:path'\nimport { getDatabase } from '../database'\nimport { IPC_CHANNELS } from '../constants'\nimport { globalContext } from '../context'\n\ninterface FolderRow {\n  id: string\n  name: string\n  parent_id: string | null\n  sort_order: number\n}\n\nfunction rowToFolder(row: FolderRow) {\n  return {\n    id: row.id,\n    name: row.name,\n    parentId: row.parent_id,\n    sortOrder: row.sort_order,\n  }\n}\n\n/** 根据文件夹 id 递归获取真实文件系统路径 */\nfunction getFolderFsPath(db: ReturnType<typeof getDatabase>, folderId: string): string | null {\n  const workspace = globalContext.currentWorkspace\n  if (!workspace) return null\n\n  const parts: string[] = []\n  let currentId: string | null = folderId\n\n  while (currentId) {\n    const row = db.prepare('SELECT id, name, parent_id FROM folders WHERE id = ?').get(currentId) as FolderRow | undefined\n    if (!row) break\n    parts.unshift(row.name)\n    currentId = row.parent_id\n  }\n\n  return path.join(workspace, ...parts)\n}\n\nexport function registerFolderHandlers() {\n  const db = getDatabase()\n\n  // 创建文件夹\n  ipcMain.handle(IPC_CHANNELS.FOLDER_CREATE, async (_event, folder) => {\n    try {\n      const id = uuidv4()\n      \n      // 获取同级文件夹中的最大排序值\n        const maxOrder = folder.parentId\n          ? db.prepare('SELECT COALESCE(MAX(sort_order), -1) as max_order FROM folders WHERE parent_id = ?').get(folder.parentId) as { max_order: number }\n          : db.prepare('SELECT COALESCE(MAX(sort_order), -1) as max_order FROM folders WHERE parent_id IS NULL').get() as { max_order: number }\n      \n      const sortOrder = (maxOrder?.max_order ?? -1) + 1\n      \n      const stmt = db.prepare(`\n        INSERT INTO folders (id, name, parent_id, sort_order)\n        VALUES (?, ?, ?, ?)\n      `)\n      \n      stmt.run(id, folder.name || '新文件夹', folder.parentId || null, sortOrder)\n\n      // 在文件系统中创建真实目录\n      const fsPath = getFolderFsPath(db, id)\n      if (fsPath && !fs.existsSync(fsPath)) {\n        fs.mkdirSync(fsPath, { recursive: true })\n      }\n\n      const created = db.prepare('SELECT * FROM folders WHERE id = ?').get(id) as FolderRow\n      return { success: true, data: rowToFolder(created) }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 更新文件夹\n  ipcMain.handle(IPC_CHANNELS.FOLDER_UPDATE, async (_event, id, updates) => {\n    try {\n      // 重命名时，先记录旧路径\n      let oldFsPath: string | null = null\n      if (updates.name !== undefined) {\n        oldFsPath = getFolderFsPath(db, id)\n      }\n\n      const fields: string[] = []\n      const values: any[] = []\n      \n      if (updates.name !== undefined) {\n        fields.push('name = ?')\n        values.push(updates.name)\n      }\n      if (updates.parentId !== undefined) {\n        fields.push('parent_id = ?')\n        values.push(updates.parentId)\n      }\n      if (updates.sortOrder !== undefined) {\n        fields.push('sort_order = ?')\n        values.push(updates.sortOrder)\n      }\n      \n      if (fields.length === 0) {\n        const existing = db.prepare('SELECT * FROM folders WHERE id = ?').get(id) as FolderRow\n        return { success: true, data: rowToFolder(existing) }\n      }\n      \n      values.push(id)\n      \n      const stmt = db.prepare(`UPDATE folders SET ${fields.join(', ')} WHERE id = ?`)\n      stmt.run(...values)\n\n      // 重命名文件系统目录\n      if (oldFsPath && updates.name !== undefined) {\n        const newFsPath = getFolderFsPath(db, id)\n        if (newFsPath && oldFsPath !== newFsPath && fs.existsSync(oldFsPath)) {\n          fs.renameSync(oldFsPath, newFsPath)\n        }\n      }\n\n      const updated = db.prepare('SELECT * FROM folders WHERE id = ?').get(id) as FolderRow\n      return { success: true, data: rowToFolder(updated) }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 删除文件夹\n  ipcMain.handle(IPC_CHANNELS.FOLDER_DELETE, async (_event, id) => {\n    try {\n      // 先获取文件系统路径，再删数据库记录\n      const fsPath = getFolderFsPath(db, id)\n\n      db.prepare('DELETE FROM folders WHERE id = ?').run(id)\n\n      // 删除文件系统目录\n      if (fsPath && fs.existsSync(fsPath)) {\n        fs.rmSync(fsPath, { recursive: true, force: true })\n      }\n\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 获取文件夹列表\n  ipcMain.handle(IPC_CHANNELS.FOLDER_LIST, async () => {\n    try {\n      const rows = db.prepare('SELECT * FROM folders ORDER BY sort_order').all() as FolderRow[]\n      return { success: true, data: rows.map(rowToFolder) }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n}\n","import { ipcMain } from 'electron'\nimport { v4 as uuidv4 } from 'uuid'\nimport { getDatabase } from '../database'\nimport { IPC_CHANNELS } from '../constants'\n\ninterface TagRow {\n  id: string\n  name: string\n  color: string\n}\n\nfunction rowToTag(row: TagRow) {\n  return {\n    id: row.id,\n    name: row.name,\n    color: row.color,\n  }\n}\n\n// 预定义的标签颜色\nconst TAG_COLORS = [\n  '#409EFF', // 蓝色\n  '#67C23A', // 绿色\n  '#E6A23C', // 橙色\n  '#F56C6C', // 红色\n  '#909399', // 灰色\n  '#9B59B6', // 紫色\n  '#1ABC9C', // 青色\n  '#E91E63', // 粉色\n]\n\nexport function registerTagHandlers() {\n  const db = getDatabase()\n\n  // 创建标签\n  ipcMain.handle(IPC_CHANNELS.TAG_CREATE, async (_event, tag) => {\n    try {\n      const id = uuidv4()\n      \n      // 随机选择一个颜色\n      const color = tag.color || TAG_COLORS[Math.floor(Math.random() * TAG_COLORS.length)]\n      \n      const stmt = db.prepare(`\n        INSERT INTO tags (id, name, color)\n        VALUES (?, ?, ?)\n      `)\n      \n      stmt.run(id, tag.name, color)\n      \n      const created = db.prepare('SELECT * FROM tags WHERE id = ?').get(id) as TagRow\n      return { success: true, data: rowToTag(created) }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 更新标签\n  ipcMain.handle(IPC_CHANNELS.TAG_UPDATE, async (_event, id, updates) => {\n    try {\n      const fields: string[] = []\n      const values: any[] = []\n      \n      if (updates.name !== undefined) {\n        fields.push('name = ?')\n        values.push(updates.name)\n      }\n      if (updates.color !== undefined) {\n        fields.push('color = ?')\n        values.push(updates.color)\n      }\n      \n      if (fields.length === 0) {\n        const existing = db.prepare('SELECT * FROM tags WHERE id = ?').get(id) as TagRow\n        return { success: true, data: rowToTag(existing) }\n      }\n      \n      values.push(id)\n      \n      const stmt = db.prepare(`UPDATE tags SET ${fields.join(', ')} WHERE id = ?`)\n      stmt.run(...values)\n      \n      const updated = db.prepare('SELECT * FROM tags WHERE id = ?').get(id) as TagRow\n      return { success: true, data: rowToTag(updated) }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 删除标签\n  ipcMain.handle(IPC_CHANNELS.TAG_DELETE, async (_event, id) => {\n    try {\n      db.prepare('DELETE FROM tags WHERE id = ?').run(id)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 获取标签列表\n  ipcMain.handle(IPC_CHANNELS.TAG_LIST, async () => {\n    try {\n      const rows = db.prepare('SELECT * FROM tags ORDER BY name').all() as TagRow[]\n      return { success: true, data: rows.map(rowToTag) }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 给笔记添加标签\n  ipcMain.handle(IPC_CHANNELS.TAG_ADD_TO_NOTE, async (_event, noteId, tagId) => {\n    try {\n      const stmt = db.prepare(`\n        INSERT OR IGNORE INTO note_tags (note_id, tag_id)\n        VALUES (?, ?)\n      `)\n      stmt.run(noteId, tagId)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 从笔记移除标签\n  ipcMain.handle(IPC_CHANNELS.TAG_REMOVE_FROM_NOTE, async (_event, noteId, tagId) => {\n    try {\n      db.prepare('DELETE FROM note_tags WHERE note_id = ? AND tag_id = ?').run(noteId, tagId)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n}\n","import { ipcMain } from 'electron'\nimport { getDatabase } from '../database'\nimport { IPC_CHANNELS } from '../constants'\n\ninterface LinkRow {\n  source_id: string\n  target_id: string\n}\n\ninterface NoteBasic {\n  id: string\n  title: string\n  type: string\n}\n\nexport function registerLinkHandlers() {\n  const db = getDatabase()\n\n  // 创建链接\n  ipcMain.handle(IPC_CHANNELS.LINK_CREATE, async (_event, sourceId, targetId) => {\n    try {\n      const stmt = db.prepare(`\n        INSERT OR IGNORE INTO links (source_id, target_id)\n        VALUES (?, ?)\n      `)\n      stmt.run(sourceId, targetId)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 删除链接\n  ipcMain.handle(IPC_CHANNELS.LINK_DELETE, async (_event, sourceId, targetId) => {\n    try {\n      db.prepare('DELETE FROM links WHERE source_id = ? AND target_id = ?').run(sourceId, targetId)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 获取笔记的所有链接\n  ipcMain.handle(IPC_CHANNELS.LINK_GET_BY_NOTE, async (_event, noteId) => {\n    try {\n      // 获取出链（当前笔记链接到的笔记）\n      const outLinks = db.prepare(`\n        SELECT n.id, n.title, n.type\n        FROM links l\n        JOIN notes n ON n.id = l.target_id\n        WHERE l.source_id = ?\n      `).all(noteId) as NoteBasic[]\n\n      // 获取入链（链接到当前笔记的笔记）\n      const inLinks = db.prepare(`\n        SELECT n.id, n.title, n.type\n        FROM links l\n        JOIN notes n ON n.id = l.source_id\n        WHERE l.target_id = ?\n      `).all(noteId) as NoteBasic[]\n\n      return {\n        success: true,\n        data: {\n          outLinks: outLinks.map(n => ({ id: n.id, title: n.title, type: n.type })),\n          inLinks: inLinks.map(n => ({ id: n.id, title: n.title, type: n.type })),\n        },\n      }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 获取知识图谱数据\n  ipcMain.handle(IPC_CHANNELS.LINK_GET_GRAPH, async () => {\n    try {\n      // 获取所有笔记作为节点\n      const notes = db.prepare(`\n        SELECT id, title, type FROM notes\n      `).all() as NoteBasic[]\n\n      // 获取所有链接作为边\n      const links = db.prepare(`\n        SELECT source_id, target_id FROM links\n      `).all() as LinkRow[]\n\n      const edges = links.map(l => ({\n          source: l.source_id,\n          target: l.target_id,\n        }))\n\n        return { success: true, data: { nodes: notes.map(n => ({ id: n.id, label: n.title, type: n.type as 'markdown' | 'bookmark' | 'snippet' })), edges } }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n}\n","import { ipcMain } from 'electron'\nimport { getDatabase } from '../database'\nimport { IPC_CHANNELS } from '../constants'\n\nexport function registerSettingsHandlers() {\n  const db = getDatabase()\n\n  // 获取设置\n  ipcMain.handle(IPC_CHANNELS.SETTINGS_GET, async () => {\n    try {\n      const rows = db.prepare('SELECT key, value FROM settings').all() as { key: string; value: string }[]\n      \n      const settings: Record<string, any> = {}\n      rows.forEach(row => {\n        try {\n          settings[row.key] = JSON.parse(row.value)\n        } catch {\n          settings[row.key] = row.value\n        }\n      })\n      \n      return { success: true, data: settings }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 保存设置\n  ipcMain.handle(IPC_CHANNELS.SETTINGS_SET, async (_event, settings) => {\n    try {\n      const stmt = db.prepare(`\n        INSERT OR REPLACE INTO settings (key, value)\n        VALUES (?, ?)\n      `)\n      \n      Object.entries(settings).forEach(([key, value]) => {\n        stmt.run(key, JSON.stringify(value))\n      })\n      \n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n}\n","import { getDatabase } from '../database'\nimport https from 'https'\nimport http from 'http'\n\ninterface AIConfig {\n  baseUrl: string\n  apiKey: string\n  model: string\n}\n\ninterface ChatMessage {\n  role: 'system' | 'user' | 'assistant'\n  content: string\n}\n\n// 当前活跃的请求，用于取消\nlet activeRequest: any = null\n\nfunction getAIConfig(): AIConfig {\n  const db = getDatabase()\n  const rows = db.prepare('SELECT key, value FROM settings WHERE key LIKE ?').all('ai_%') as { key: string; value: string }[]\n  const config: Record<string, string> = {}\n  rows.forEach((r: { key: string; value: string }) => {\n    try { config[r.key] = JSON.parse(r.value) } catch { config[r.key] = r.value }\n  })\n  return {\n    baseUrl: config['ai_base_url'] || 'https://api.deepseek.com',\n    apiKey: config['ai_api_key'] || 'sk-376363b4a79e4bb5ae5f329706efc0f4',\n    model: config['ai_model'] || 'deepseek-chat',\n  }\n}\n\nexport async function aiChat(messages: ChatMessage[], systemPrompt?: string): Promise<string> {\n  const config = getAIConfig()\n  if (!config.apiKey) throw new Error('请先在设置中配置 AI API Key')\n\n  const allMessages: ChatMessage[] = []\n  if (systemPrompt) {\n    allMessages.push({ role: 'system', content: systemPrompt })\n  }\n  allMessages.push(...messages)\n\n  const body = JSON.stringify({\n    model: config.model,\n    messages: allMessages,\n    temperature: 0.7,\n    max_tokens: 2048,\n  })\n\n  return new Promise((resolve, reject) => {\n    const url = new URL(config.baseUrl.replace(/\\/$/, '') + '/chat/completions')\n    const isHttps = url.protocol === 'https:'\n    const transport = isHttps ? https : http\n\n    const req = transport.request({\n      hostname: url.hostname,\n      port: url.port || (isHttps ? 443 : 80),\n      path: url.pathname + url.search,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${config.apiKey}`,\n      },\n    }, (res) => {\n      let data = ''\n      res.on('data', (chunk: Buffer) => { data += chunk.toString() })\n      res.on('end', () => {\n        try {\n          const json = JSON.parse(data)\n          if (json.error) {\n            reject(new Error(json.error.message || JSON.stringify(json.error)))\n            return\n          }\n          resolve(json.choices?.[0]?.message?.content || '')\n        } catch (e) {\n          reject(new Error('AI 响应解析失败: ' + data.slice(0, 200)))\n        }\n      })\n    })\n\n    activeRequest = req\n    req.on('error', (e: Error) => reject(new Error('AI 请求失败: ' + e.message)))\n    req.write(body)\n    req.end()\n  })\n}\n\nexport async function aiChatStream(\n  messages: ChatMessage[],\n  systemPrompt: string | undefined,\n  onChunk: (text: string) => void,\n  onDone: () => void,\n  onError: (err: string) => void\n): Promise<void> {\n  const config = getAIConfig()\n  if (!config.apiKey) {\n    onError('请先在设置中配置 AI API Key')\n    return\n  }\n\n  const allMessages: ChatMessage[] = []\n  if (systemPrompt) {\n    allMessages.push({ role: 'system', content: systemPrompt })\n  }\n  allMessages.push(...messages)\n\n  const body = JSON.stringify({\n    model: config.model,\n    messages: allMessages,\n    temperature: 0.7,\n    max_tokens: 2048,\n    stream: true,\n  })\n\n  const url = new URL(config.baseUrl.replace(/\\/$/, '') + '/chat/completions')\n  const isHttps = url.protocol === 'https:'\n  const transport = isHttps ? https : http\n\n  const req = transport.request({\n    hostname: url.hostname,\n    port: url.port || (isHttps ? 443 : 80),\n    path: url.pathname + url.search,\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${config.apiKey}`,\n    },\n  }, (res) => {\n    let buffer = ''\n    res.on('data', (chunk: Buffer) => {\n      buffer += chunk.toString()\n      const lines = buffer.split('\\n')\n      buffer = lines.pop() || ''\n\n      for (const line of lines) {\n        const trimmed = line.trim()\n        if (!trimmed || !trimmed.startsWith('data: ')) continue\n        const data = trimmed.slice(6)\n        if (data === '[DONE]') {\n          onDone()\n          return\n        }\n        try {\n          const json = JSON.parse(data)\n          const content = json.choices?.[0]?.delta?.content\n          if (content) onChunk(content)\n        } catch {\n          // ignore parse errors in stream\n        }\n      }\n    })\n    res.on('end', () => onDone())\n  })\n\n  activeRequest = req\n  req.on('error', (e: Error) => onError('AI 请求失败: ' + e.message))\n  req.write(body)\n  req.end()\n}\n\nexport function aiStop() {\n  if (activeRequest) {\n    activeRequest.destroy()\n    activeRequest = null\n  }\n}\n\n// --- Utility AI functions ---\n\nconst SYSTEM_PROMPTS = {\n  summarize: '你是一个知识库助手。请用简洁的语言总结以下内容，提取核心要点。用中文回答。',\n  suggestTags: '你是一个知识库助手。请根据以下内容建议 3-5 个合适的标签。只输出标签名，用逗号分隔，不要其他内容。用中文回答。',\n  polish: '你是一个写作助手。请润色以下文字，使其更加通顺、专业，保持原意不变。直接输出润色后的内容，不要其他说明。',\n  continue: '你是一个写作助手。请根据以下内容继续往下写，保持风格一致，自然地扩展内容。直接输出续写内容，不要重复已有内容。',\n  translate: '你是一个翻译助手。请将以下内容翻译成{lang}。直接输出翻译结果，不要其他说明。',\n  explain: '你是一个知识库助手。请用通俗易懂的语言解释以下内容。用中文回答。',\n  searchEnhance: '你是一个搜索助手。用户想搜索以下内容，请帮忙扩展搜索关键词，生成 3-5 个相关的搜索词。只输出关键词，用逗号分隔。',\n  knowledgeChat: '你是一个智能知识库助手。用户会向你提问关于他们知识库中内容的问题。以下是相关的知识库内容，请基于这些内容回答用户的问题。如果知识库中没有相关信息，请如实告知。用中文回答。',\n}\n\nexport async function aiSummarize(content: string): Promise<string> {\n  return aiChat([{ role: 'user', content }], SYSTEM_PROMPTS.summarize)\n}\n\nexport async function aiSuggestTags(content: string): Promise<string[]> {\n  const result = await aiChat([{ role: 'user', content }], SYSTEM_PROMPTS.suggestTags)\n  return result.split(/[,，、]/).map(t => t.trim()).filter(Boolean)\n}\n\nexport async function aiPolish(content: string): Promise<string> {\n  return aiChat([{ role: 'user', content }], SYSTEM_PROMPTS.polish)\n}\n\nexport async function aiContinue(content: string): Promise<string> {\n  return aiChat([{ role: 'user', content }], SYSTEM_PROMPTS.continue)\n}\n\nexport async function aiTranslate(content: string, lang: string): Promise<string> {\n  const prompt = SYSTEM_PROMPTS.translate.replace('{lang}', lang)\n  return aiChat([{ role: 'user', content }], prompt)\n}\n\nexport async function aiExplain(content: string): Promise<string> {\n  return aiChat([{ role: 'user', content }], SYSTEM_PROMPTS.explain)\n}\n\nexport async function aiSearchEnhance(query: string): Promise<string[]> {\n  const result = await aiChat([{ role: 'user', content: query }], SYSTEM_PROMPTS.searchEnhance)\n  return result.split(/[,，、]/).map(t => t.trim()).filter(Boolean)\n}\n\nexport { SYSTEM_PROMPTS }\nexport type { ChatMessage, AIConfig }\n","import { getDatabase } from '../database'\r\nimport https from 'https'\r\n\r\nexport interface WebSearchResult {\r\n  title: string\r\n  url: string\r\n  snippet: string\r\n}\r\n\r\ninterface SearchConfig {\r\n  tavilyKey?: string\r\n  googleKey?: string\r\n  googleCx?: string\r\n  bochaKey?: string\r\n  serperKey?: string\r\n}\r\n\r\nexport function getSearchConfig(): SearchConfig {\r\n  const db = getDatabase()\r\n  const rows = db.prepare('SELECT key, value FROM settings WHERE key LIKE ?').all('search_%') as { key: string; value: string }[]\r\n  const config: Record<string, string> = {}\r\n  rows.forEach((r: { key: string; value: string }) => {\r\n    try { config[r.key] = JSON.parse(r.value) } catch { config[r.key] = r.value }\r\n  })\r\n  return {\r\n    tavilyKey: config['search_tavily_key'] || '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',\r\n    googleKey: config['search_google_key'] || 'AIzaSyBVX6rTEuPciJ87n87fkY70Y_lZess2XXc',\r\n    googleCx: config['search_google_cx'] || undefined,\r\n    bochaKey: config['search_bocha_key'] || 'sk-8d34ebe45906488499ed771af68d1a43',\r\n    serperKey: config['search_serper_key'] || '1c70b54b855778cb90ea5d2e168b9bed16f6eb6f',\r\n  }\r\n}\r\n\r\n// 封装 https.request 为 Promise\r\nfunction httpsRequest(options: https.RequestOptions, body?: string): Promise<string> {\r\n  return new Promise((resolve, reject) => {\r\n    const req = https.request(options, (res) => {\r\n      let data = ''\r\n      res.on('data', (chunk: Buffer) => { data += chunk.toString() })\r\n      res.on('end', () => resolve(data))\r\n    })\r\n    req.on('error', (e: Error) => reject(new Error('请求失败: ' + e.message)))\r\n    if (body) req.write(body)\r\n    req.end()\r\n  })\r\n}\r\n\r\n// 封装 https.get 为 Promise\r\nfunction httpsGet(url: string): Promise<string> {\r\n  return new Promise((resolve, reject) => {\r\n    https.get(url, (res) => {\r\n      let data = ''\r\n      res.on('data', (chunk: Buffer) => { data += chunk.toString() })\r\n      res.on('end', () => resolve(data))\r\n    }).on('error', (e: Error) => reject(new Error('请求失败: ' + e.message)))\r\n  })\r\n}\r\n\r\n// --- 搜索提供商 ---\r\n\r\nasync function searchTavily(query: string, apiKey: string): Promise<WebSearchResult[]> {\r\n  const body = JSON.stringify({\r\n    api_key: apiKey,\r\n    query,\r\n    search_depth: 'basic',\r\n    max_results: 5,\r\n  })\r\n\r\n  const data = await httpsRequest({\r\n    hostname: 'api.tavily.com',\r\n    path: '/search',\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n    },\r\n  }, body)\r\n\r\n  const json = JSON.parse(data)\r\n  if (json.error) throw new Error(json.error)\r\n  return json.results.map((r: any) => ({\r\n    title: r.title,\r\n    url: r.url,\r\n    snippet: r.content,\r\n  }))\r\n}\r\n\r\nasync function searchSerper(query: string, apiKey: string): Promise<WebSearchResult[]> {\r\n  const body = JSON.stringify({\r\n    q: query,\r\n    num: 5,\r\n  })\r\n\r\n  const data = await httpsRequest({\r\n    hostname: 'google.serper.dev',\r\n    path: '/search',\r\n    method: 'POST',\r\n    headers: {\r\n      'X-API-KEY': apiKey,\r\n      'Content-Type': 'application/json',\r\n    },\r\n  }, body)\r\n\r\n  const json = JSON.parse(data)\r\n  if (json.error) throw new Error(json.error)\r\n  return json.organic.map((r: any) => ({\r\n    title: r.title,\r\n    url: r.link,\r\n    snippet: r.snippet,\r\n  }))\r\n}\r\n\r\nasync function searchGoogle(query: string, apiKey: string, cx: string): Promise<WebSearchResult[]> {\r\n  const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(query)}&num=5`\r\n\r\n  const data = await httpsGet(url)\r\n  const json = JSON.parse(data)\r\n  if (json.error) throw new Error(json.error.message || JSON.stringify(json.error))\r\n  return (json.items || []).map((r: any) => ({\r\n    title: r.title,\r\n    url: r.link,\r\n    snippet: r.snippet,\r\n  }))\r\n}\r\n\r\nasync function searchBocha(query: string, apiKey: string): Promise<WebSearchResult[]> {\r\n  const body = JSON.stringify({\r\n    query,\r\n    freshness: 'noLimit',\r\n    summary: true,\r\n    count: 5,\r\n  })\r\n\r\n  const data = await httpsRequest({\r\n    hostname: 'api.bochaai.com',\r\n    path: '/v1/web-search',\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': `Bearer ${apiKey}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n  }, body)\r\n\r\n  const json = JSON.parse(data)\r\n  if (json.error) throw new Error(json.error)\r\n  return json.data?.webPages?.value?.map((r: any) => ({\r\n    title: r.name,\r\n    url: r.url,\r\n    snippet: r.snippet,\r\n  })) || []\r\n}\r\n\r\n// --- 主搜索函数 ---\r\n\r\nexport async function webSearch(query: string): Promise<WebSearchResult[]> {\r\n  const config = getSearchConfig()\r\n\r\n  const providers: { name: string; fn: () => Promise<WebSearchResult[]> }[] = []\r\n\r\n  if (config.tavilyKey) {\r\n    providers.push({ name: 'Tavily', fn: () => searchTavily(query, config.tavilyKey!) })\r\n  }\r\n  if (config.serperKey) {\r\n    providers.push({ name: 'Serper', fn: () => searchSerper(query, config.serperKey!) })\r\n  }\r\n  if (config.googleKey && config.googleCx) {\r\n    providers.push({ name: 'Google', fn: () => searchGoogle(query, config.googleKey!, config.googleCx!) })\r\n  }\r\n  if (config.bochaKey) {\r\n    providers.push({ name: 'Bocha', fn: () => searchBocha(query, config.bochaKey!) })\r\n  }\r\n\r\n  if (providers.length === 0) {\r\n    throw new Error('未配置搜索 API，请在设置中添加搜索 API Key')\r\n  }\r\n\r\n  let lastError: Error | null = null\r\n  for (const provider of providers) {\r\n    try {\r\n      const results = await provider.fn()\r\n      return results\r\n    } catch (e) {\r\n      lastError = e instanceof Error ? e : new Error(String(e))\r\n      console.error(`[WebSearch] ${provider.name} 搜索失败:`, lastError.message)\r\n    }\r\n  }\r\n\r\n  throw lastError || new Error('未配置搜索 API，请在设置中添加搜索 API Key')\r\n}\r\n","import { ipcMain, BrowserWindow } from 'electron'\nimport { getDatabase } from '../database'\nimport { IPC_CHANNELS } from '../constants'\nimport {\n  aiChat,\n  aiChatStream,\n  aiStop,\n  aiSummarize,\n  aiSuggestTags,\n  aiPolish,\n  aiContinue,\n  aiTranslate,\n  aiExplain,\n  aiSearchEnhance,\n} from './service'\nimport { webSearch } from './websearch'\nimport type { ChatMessage } from './service'\n\nexport function registerAIHandlers() {\n  const db = getDatabase()\n\n  // 初始化 AI 聊天历史表\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS ai_conversations (\n      id TEXT PRIMARY KEY,\n      title TEXT NOT NULL DEFAULT '新对话',\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n    )\n  `)\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS ai_messages (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      conversation_id TEXT NOT NULL,\n      role TEXT NOT NULL,\n      content TEXT NOT NULL,\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (conversation_id) REFERENCES ai_conversations(id) ON DELETE CASCADE\n    )\n  `)\n\n  // 非流式聊天\n  ipcMain.handle(IPC_CHANNELS.AI_CHAT, async (_event, messages: ChatMessage[], systemPrompt?: string) => {\n    try {\n      const result = await aiChat(messages, systemPrompt)\n      return { success: true, data: result }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 流式聊天\n  ipcMain.handle(IPC_CHANNELS.AI_CHAT_STREAM, async (event, messages: ChatMessage[], systemPrompt?: string) => {\n    try {\n      const win = BrowserWindow.fromWebContents(event.sender)\n      await aiChatStream(\n        messages,\n        systemPrompt,\n        (text) => {\n          if (win && !win.isDestroyed()) {\n            win.webContents.send('ai:stream:chunk', text)\n          }\n        },\n        () => {\n          if (win && !win.isDestroyed()) {\n            win.webContents.send('ai:stream:done')\n          }\n        },\n        (err) => {\n          if (win && !win.isDestroyed()) {\n            win.webContents.send('ai:stream:error', err)\n          }\n        }\n      )\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 停止生成\n  ipcMain.handle(IPC_CHANNELS.AI_STOP, async () => {\n    aiStop()\n    return { success: true }\n  })\n\n  // 总结\n  ipcMain.handle(IPC_CHANNELS.AI_SUMMARIZE, async (_event, content: string) => {\n    try {\n      const result = await aiSummarize(content)\n      return { success: true, data: result }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 建议标签\n  ipcMain.handle(IPC_CHANNELS.AI_SUGGEST_TAGS, async (_event, content: string) => {\n    try {\n      const result = await aiSuggestTags(content)\n      return { success: true, data: result }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 润色\n  ipcMain.handle(IPC_CHANNELS.AI_POLISH, async (_event, content: string) => {\n    try {\n      const result = await aiPolish(content)\n      return { success: true, data: result }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 续写\n  ipcMain.handle(IPC_CHANNELS.AI_CONTINUE, async (_event, content: string) => {\n    try {\n      const result = await aiContinue(content)\n      return { success: true, data: result }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 翻译\n  ipcMain.handle(IPC_CHANNELS.AI_TRANSLATE, async (_event, content: string, lang: string) => {\n    try {\n      const result = await aiTranslate(content, lang)\n      return { success: true, data: result }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 解释\n  ipcMain.handle(IPC_CHANNELS.AI_EXPLAIN, async (_event, content: string) => {\n    try {\n      const result = await aiExplain(content)\n      return { success: true, data: result }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 搜索增强\n  ipcMain.handle(IPC_CHANNELS.AI_SEARCH_ENHANCE, async (_event, query: string) => {\n    try {\n      const result = await aiSearchEnhance(query)\n      return { success: true, data: result }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 联网搜索\n  ipcMain.handle(IPC_CHANNELS.AI_WEB_SEARCH, async (_event, query: string) => {\n    try {\n      const results = await webSearch(query)\n      return { success: true, data: results }\n    } catch (error: any) {\n      return { success: false, error: error.message || String(error) }\n    }\n  })\n\n  // 聊天历史 - 列表\n  ipcMain.handle(IPC_CHANNELS.AI_CHAT_HISTORY_LIST, async () => {\n    try {\n      const rows = db.prepare('SELECT * FROM ai_conversations ORDER BY updated_at DESC').all()\n      return { success: true, data: rows }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 聊天历史 - 获取\n  ipcMain.handle(IPC_CHANNELS.AI_CHAT_HISTORY_GET, async (_event, conversationId: string) => {\n    try {\n      const messages = db.prepare('SELECT * FROM ai_messages WHERE conversation_id = ? ORDER BY created_at ASC').all(conversationId)\n      return { success: true, data: messages }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 聊天历史 - 保存\n  ipcMain.handle(IPC_CHANNELS.AI_CHAT_HISTORY_SAVE, async (_event, conversationId: string, title: string, messages: { role: string; content: string }[]) => {\n    try {\n      // upsert conversation\n      db.prepare(`\n        INSERT INTO ai_conversations (id, title, updated_at) VALUES (?, ?, CURRENT_TIMESTAMP)\n        ON CONFLICT(id) DO UPDATE SET title = ?, updated_at = CURRENT_TIMESTAMP\n      `).run(conversationId, title, title)\n\n      // delete old messages and re-insert\n      db.prepare('DELETE FROM ai_messages WHERE conversation_id = ?').run(conversationId)\n      const insert = db.prepare('INSERT INTO ai_messages (conversation_id, role, content) VALUES (?, ?, ?)')\n      for (const msg of messages) {\n        insert.run(conversationId, msg.role, msg.content)\n      }\n\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // 聊天历史 - 删除\n  ipcMain.handle(IPC_CHANNELS.AI_CHAT_HISTORY_DELETE, async (_event, conversationId: string) => {\n    try {\n      db.prepare('DELETE FROM ai_conversations WHERE id = ?').run(conversationId)\n      return { success: true }\n    } catch (error) {\n      return { success: false, error: String(error) }\n    }\n  })\n}\n","import { ipcMain, dialog, shell } from 'electron'\r\nimport { v4 as uuidv4 } from 'uuid'\r\nimport fs from 'node:fs'\r\nimport path from 'node:path'\r\nimport { getDatabase } from '../database'\r\nimport { IPC_CHANNELS } from '../constants'\r\nimport { globalContext } from '../context'\r\n\r\ninterface AttachmentRow {\r\n  id: string\r\n  note_id: string\r\n  filename: string\r\n  stored_name: string\r\n  mime_type: string\r\n  category: string\r\n  size: number\r\n  width: number | null\r\n  height: number | null\r\n  duration: number | null\r\n  created_at: string\r\n}\r\n\r\nfunction rowToAttachment(row: AttachmentRow) {\r\n  return {\r\n    id: row.id,\r\n    noteId: row.note_id,\r\n    filename: row.filename,\r\n    storedName: row.stored_name,\r\n    mimeType: row.mime_type,\r\n    category: row.category,\r\n    size: row.size,\r\n    width: row.width,\r\n    height: row.height,\r\n    duration: row.duration,\r\n    createdAt: row.created_at,\r\n  }\r\n}\r\n\r\nfunction getAttachmentsDir(category: string): string | null {\r\n  const workspace = globalContext.currentWorkspace\r\n  if (!workspace) return null\r\n  const dir = path.join(workspace, '_attachments', category)\r\n  if (!fs.existsSync(dir)) {\r\n    fs.mkdirSync(dir, { recursive: true })\r\n  }\r\n  return dir\r\n}\r\n\r\nfunction getExtFromFilename(filename: string): string {\r\n  const ext = path.extname(filename).toLowerCase()\r\n  return ext || '.bin'\r\n}\r\n\r\nfunction getMimeType(ext: string): string {\r\n  const map: Record<string, string> = {\r\n    '.jpg': 'image/jpeg', '.jpeg': 'image/jpeg', '.png': 'image/png',\r\n    '.gif': 'image/gif', '.webp': 'image/webp', '.svg': 'image/svg+xml',\r\n    '.bmp': 'image/bmp', '.ico': 'image/x-icon',\r\n    '.mp3': 'audio/mpeg', '.wav': 'audio/wav', '.ogg': 'audio/ogg',\r\n    '.webm': 'audio/webm', '.flac': 'audio/flac', '.aac': 'audio/aac',\r\n    '.m4a': 'audio/mp4',\r\n    '.mp4': 'video/mp4', '.avi': 'video/x-msvideo', '.mov': 'video/quicktime',\r\n    '.mkv': 'video/x-matroska',\r\n    '.pdf': 'application/pdf',\r\n    '.doc': 'application/msword',\r\n    '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\r\n    '.xls': 'application/vnd.ms-excel',\r\n    '.xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n    '.ppt': 'application/vnd.ms-powerpoint',\r\n    '.pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',\r\n    '.txt': 'text/plain', '.csv': 'text/csv',\r\n  }\r\n  return map[ext] || 'application/octet-stream'\r\n}\r\n\r\nexport function registerAttachmentHandlers() {\r\n  const db = getDatabase()\r\n\r\n  // 上传附件\r\n  ipcMain.handle(IPC_CHANNELS.ATTACHMENT_UPLOAD, async (_event, params) => {\r\n    try {\r\n      const { noteId, filename, buffer, mimeType, category, width, height, duration } = params\r\n      const dir = getAttachmentsDir(category)\r\n      if (!dir) return { success: false, error: 'No workspace set' }\r\n\r\n      const id = uuidv4()\r\n      const ext = getExtFromFilename(filename)\r\n      const storedName = `${id}${ext}`\r\n      const filePath = path.join(dir, storedName)\r\n\r\n      // 写入文件 - buffer 从 IPC 传来是 ArrayBuffer 或 Uint8Array\r\n      const data = Buffer.from(buffer)\r\n      fs.writeFileSync(filePath, data)\r\n\r\n      const size = data.length\r\n\r\n      // 插入 DB\r\n      db.prepare(`\r\n        INSERT INTO attachments (id, note_id, filename, stored_name, mime_type, category, size, width, height, duration)\r\n        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n      `).run(id, noteId, filename, storedName, mimeType, category, size, width || null, height || null, duration || null)\r\n\r\n      const relativePath = `_attachments/${category}/${storedName}`\r\n      return {\r\n        success: true,\r\n        data: {\r\n          id,\r\n          storedName,\r\n          relativePath,\r\n          absolutePath: filePath,\r\n          url: `attachment://${filePath}`,\r\n        }\r\n      }\r\n    } catch (error) {\r\n      return { success: false, error: String(error) }\r\n    }\r\n  })\r\n\r\n  // 删除附件\r\n  ipcMain.handle(IPC_CHANNELS.ATTACHMENT_DELETE, async (_event, id: string) => {\r\n    try {\r\n      const row = db.prepare('SELECT * FROM attachments WHERE id = ?').get(id) as AttachmentRow | undefined\r\n      if (!row) return { success: false, error: 'Attachment not found' }\r\n\r\n      // 删除文件\r\n      const workspace = globalContext.currentWorkspace\r\n      if (workspace) {\r\n        const filePath = path.join(workspace, '_attachments', row.category, row.stored_name)\r\n        if (fs.existsSync(filePath)) {\r\n          fs.unlinkSync(filePath)\r\n        }\r\n      }\r\n\r\n      // 删除 DB 记录\r\n      db.prepare('DELETE FROM attachments WHERE id = ?').run(id)\r\n      return { success: true }\r\n    } catch (error) {\r\n      return { success: false, error: String(error) }\r\n    }\r\n  })\r\n\r\n  // 获取单个附件\r\n  ipcMain.handle(IPC_CHANNELS.ATTACHMENT_GET, async (_event, id: string) => {\r\n    try {\r\n      const row = db.prepare('SELECT * FROM attachments WHERE id = ?').get(id) as AttachmentRow | undefined\r\n      if (!row) return { success: false, error: 'Not found' }\r\n      return { success: true, data: rowToAttachment(row) }\r\n    } catch (error) {\r\n      return { success: false, error: String(error) }\r\n    }\r\n  })\r\n\r\n  // 列出笔记附件\r\n  ipcMain.handle(IPC_CHANNELS.ATTACHMENT_LIST, async (_event, noteId: string, category?: string) => {\r\n    try {\r\n      let rows: AttachmentRow[]\r\n      if (category) {\r\n        rows = db.prepare('SELECT * FROM attachments WHERE note_id = ? AND category = ? ORDER BY created_at DESC')\r\n          .all(noteId, category) as AttachmentRow[]\r\n      } else {\r\n        rows = db.prepare('SELECT * FROM attachments WHERE note_id = ? ORDER BY created_at DESC')\r\n          .all(noteId) as AttachmentRow[]\r\n      }\r\n      return { success: true, data: rows.map(rowToAttachment) }\r\n    } catch (error) {\r\n      return { success: false, error: String(error) }\r\n    }\r\n  })\r\n\r\n  // 获取附件路径\r\n  ipcMain.handle(IPC_CHANNELS.ATTACHMENT_GET_PATH, async (_event, id: string) => {\r\n    try {\r\n      const row = db.prepare('SELECT * FROM attachments WHERE id = ?').get(id) as AttachmentRow | undefined\r\n      if (!row) return { success: false, error: 'Not found' }\r\n\r\n      const workspace = globalContext.currentWorkspace\r\n      if (!workspace) return { success: false, error: 'No workspace' }\r\n\r\n      const absolutePath = path.join(workspace, '_attachments', row.category, row.stored_name)\r\n      return { success: true, data: { absolutePath, url: `attachment://${absolutePath}` } }\r\n    } catch (error) {\r\n      return { success: false, error: String(error) }\r\n    }\r\n  })\r\n\r\n  // 用系统程序打开\r\n  ipcMain.handle(IPC_CHANNELS.ATTACHMENT_OPEN, async (_event, id: string) => {\r\n    try {\r\n      const row = db.prepare('SELECT * FROM attachments WHERE id = ?').get(id) as AttachmentRow | undefined\r\n      if (!row) return { success: false, error: 'Not found' }\r\n\r\n      const workspace = globalContext.currentWorkspace\r\n      if (!workspace) return { success: false, error: 'No workspace' }\r\n\r\n      const filePath = path.join(workspace, '_attachments', row.category, row.stored_name)\r\n      await shell.openPath(filePath)\r\n      return { success: true }\r\n    } catch (error) {\r\n      return { success: false, error: String(error) }\r\n    }\r\n  })\r\n\r\n  // 文件选择器\r\n  ipcMain.handle(IPC_CHANNELS.ATTACHMENT_PICK_FILE, async (_event, options?: { category?: string; multiple?: boolean }) => {\r\n    try {\r\n      const filters: Electron.FileFilter[] = []\r\n\r\n      if (options?.category === 'image') {\r\n        filters.push({ name: 'Images', extensions: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'ico'] })\r\n      } else if (options?.category === 'audio') {\r\n        filters.push({ name: 'Audio', extensions: ['mp3', 'wav', 'ogg', 'webm', 'flac', 'aac', 'm4a'] })\r\n      } else if (options?.category === 'video') {\r\n        filters.push({ name: 'Video', extensions: ['mp4', 'webm', 'avi', 'mov', 'mkv'] })\r\n      } else if (options?.category === 'document') {\r\n        filters.push({ name: 'Documents', extensions: ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'csv'] })\r\n      }\r\n      filters.push({ name: 'All Files', extensions: ['*'] })\r\n\r\n      const properties: Electron.OpenDialogOptions['properties'] = ['openFile']\r\n      if (options?.multiple) {\r\n        properties.push('multiSelections')\r\n      }\r\n\r\n      const result = await dialog.showOpenDialog({\r\n        properties,\r\n        filters,\r\n      })\r\n\r\n      if (result.canceled || result.filePaths.length === 0) {\r\n        return { success: true, data: [] }\r\n      }\r\n\r\n      const files = result.filePaths.map(fp => {\r\n        const fileBuffer = fs.readFileSync(fp)\r\n        const filename = path.basename(fp)\r\n        const ext = path.extname(fp).toLowerCase()\r\n        const mimeType = getMimeType(ext)\r\n        return {\r\n          filename,\r\n          buffer: fileBuffer.buffer,\r\n          mimeType,\r\n          size: fileBuffer.length,\r\n        }\r\n      })\r\n\r\n      return { success: true, data: files }\r\n    } catch (error) {\r\n      return { success: false, error: String(error) }\r\n    }\r\n  })\r\n}\r\n","import { ipcMain, dialog, shell } from 'electron'\nimport { IPC_CHANNELS } from '../constants'\nimport * as fs from 'fs'\nimport * as path from 'path'\nimport { v4 as uuidv4 } from 'uuid'\nimport { getDatabase } from '../database'\nimport { globalContext } from '../context'\n\nexport function registerDialogHandlers() {\n  ipcMain.handle('dialog:openDirectory', async () => {\n    const result = await dialog.showOpenDialog({\n      properties: ['openDirectory', 'createDirectory']\n    })\n    \n    if (result.canceled) {\n      return null\n    }\n    \n    return result.filePaths[0]\n  })\n\n  // 设置当前工作区并同步文件\n  ipcMain.handle('workspace:set', async (_event, workspacePath: string) => {\n    console.log('[Main] Setting workspace:', workspacePath)\n    globalContext.currentWorkspace = workspacePath\n    \n    // 立即扫描并同步\n    try {\n      if (!fs.existsSync(workspacePath)) return false\n      \n      const db = getDatabase()\n      const files = fs.readdirSync(workspacePath)\n      const mdFiles = files.filter(f => f.endsWith('.md'))\n      \n      console.log(`[Main] Found ${mdFiles.length} markdown files to sync`)\n      \n      const now = new Date().toISOString()\n      \n      // 简单同步逻辑：如果 DB 里没有同名文件，就插入\n      // 如果 DB 里有，但文件内容变了，就更新 DB (简化起见先只做导入)\n      for (const file of mdFiles) {\n        const title = path.basename(file, '.md')\n        const content = fs.readFileSync(path.join(workspacePath, file), 'utf-8')\n        \n        // 检查是否存在（按 title）\n        const existing = db.prepare('SELECT id FROM notes WHERE title = ?').get(title) as any\n        \n        if (!existing) {\n          const id = uuidv4()\n          db.prepare(`\n            INSERT INTO notes (id, title, content, type, created_at, updated_at)\n            VALUES (?, ?, ?, ?, ?, ?)\n          `).run(id, title, content, 'markdown', now, now)\n          console.log(`[Main] Imported note: ${title}`)\n        } else {\n           // 可选：更新内容\n           // db.prepare('UPDATE notes SET content = ? WHERE id = ?').run(content, existing.id)\n        }\n      }\n      return true\n    } catch (e) {\n      console.error('[Main] Sync failed:', e)\n      return false\n    }\n  })\n\n  // 在文件资源管理器中显示\n  ipcMain.handle(IPC_CHANNELS.SYSTEM_REVEAL, async (_event, filePath: string) => {\n    try {\n      if (fs.existsSync(filePath)) {\n        shell.showItemInFolder(filePath)\n        return true\n      }\n      return false\n    } catch (e) {\n      console.error('[Main] Reveal failed:', e)\n      return false\n    }\n  })\n}\n","import { registerNoteHandlers } from './notes'\nimport { registerFolderHandlers } from './folders'\nimport { registerTagHandlers } from './tags'\nimport { registerLinkHandlers } from './links'\nimport { registerSettingsHandlers } from './settings'\nimport { registerAIHandlers } from '../ai'\nimport { registerAttachmentHandlers } from './attachments'\nimport { registerDialogHandlers } from './dialog'\n\nexport function registerAllHandlers() {\n  registerNoteHandlers()\n  registerFolderHandlers()\n  registerTagHandlers()\n  registerLinkHandlers()\n  registerSettingsHandlers()\n  registerAIHandlers()\n  registerAttachmentHandlers()\n  registerDialogHandlers()\n}\n","import { app, BrowserWindow, protocol } from 'electron'\nimport { fileURLToPath } from 'node:url'\nimport path from 'node:path'\nimport { initDatabase, closeDatabase } from './database'\nimport { registerAllHandlers } from './ipc'\n\nconst __dirname = path.dirname(fileURLToPath(import.meta.url))\n\n// The built directory structure\n//\n// ├─┬─┬ dist\n// │ │ └── index.html\n// │ │\n// │ ├─┬ dist-electron\n// │ │ ├── main.js\n// │ │ └── preload.mjs\n// │\nprocess.env.APP_ROOT = path.join(__dirname, '..')\n\n// 🚧 Use ['ENV_NAME'] avoid vite:define plugin - Vite@2.x\nexport const VITE_DEV_SERVER_URL = process.env['VITE_DEV_SERVER_URL']\nexport const MAIN_DIST = path.join(process.env.APP_ROOT, 'dist-electron')\nexport const RENDERER_DIST = path.join(process.env.APP_ROOT, 'dist')\n\nprocess.env.VITE_PUBLIC = VITE_DEV_SERVER_URL ? path.join(process.env.APP_ROOT, 'public') : RENDERER_DIST\n\nlet win: BrowserWindow | null\n\nfunction createWindow() {\n  win = new BrowserWindow({\n    width: 1400,\n    height: 900,\n    minWidth: 1000,\n    minHeight: 600,\n    icon: path.join(process.env.VITE_PUBLIC, 'electron-vite.svg'),\n    titleBarStyle: 'hiddenInset',\n    trafficLightPosition: { x: 16, y: 16 },\n    webPreferences: {\n      preload: path.join(__dirname, 'preload.mjs'),\n      nodeIntegration: false,\n      contextIsolation: true,\n    },\n  })\n\n  // Test active push message to Renderer-process.\n  win.webContents.on('did-finish-load', () => {\n    win?.webContents.send('main-process-message', (new Date).toLocaleString())\n  })\n\n  if (VITE_DEV_SERVER_URL) {\n    win.loadURL(VITE_DEV_SERVER_URL)\n  } else {\n    // win.loadFile('dist/index.html')\n    win.loadFile(path.join(RENDERER_DIST, 'index.html'))\n  }\n}\n\n// Quit when all windows are closed, except on macOS. There, it's common\n// for applications and their menu bar to stay active until the user quits\n// explicitly with Cmd + Q.\napp.on('window-all-closed', () => {\n  if (process.platform !== 'darwin') {\n    app.quit()\n    win = null\n  }\n})\n\napp.on('activate', () => {\n  // On OS X it's common to re-create a window in the app when the\n  // dock icon is clicked and there are no other windows open.\n  if (BrowserWindow.getAllWindows().length === 0) {\n    createWindow()\n  }\n})\n\n// 应用退出时关闭数据库\napp.on('before-quit', () => {\n  closeDatabase()\n})\n\napp.whenReady().then(() => {\n  // 注册 attachment:// 自定义协议\n  protocol.registerFileProtocol('attachment', (request, callback) => {\n    const filePath = decodeURIComponent(request.url.replace('attachment://', ''))\n    callback({ path: filePath })\n  })\n\n  // 初始化数据库\n  initDatabase()\n  // 注册所有 IPC 处理器\n  registerAllHandlers()\n  // 创建窗口\n  createWindow()\n})\n"],"names":["require","createRequire","Database","db","getDatabase","initDatabase","userDataPath","app","dbPath","path","fs","closeDatabase","byteToHex","i","unsafeStringify","arr","offset","rnds8Pool","poolPtr","rng","randomFillSync","native","randomUUID","_v4","options","buf","rnds","_a","v4","IPC_CHANNELS","globalContext","rowToNote","row","registerNoteHandlers","ipcMain","_event","note","id","uuidv4","now","created","filename","filePath","e","error","updates","existing","fields","values","updated","oldPath","filters","sql","params","query","searchTerm","snippet","idx","start","end","matchField","rowToFolder","getFolderFsPath","folderId","workspace","parts","currentId","registerFolderHandlers","folder","maxOrder","sortOrder","fsPath","oldFsPath","newFsPath","rowToTag","TAG_COLORS","registerTagHandlers","tag","color","noteId","tagId","registerLinkHandlers","sourceId","targetId","outLinks","inLinks","n","notes","edges","l","registerSettingsHandlers","rows","settings","stmt","key","value","activeRequest","getAIConfig","config","r","aiChat","messages","systemPrompt","allMessages","body","resolve","reject","url","isHttps","req","https","http","res","data","chunk","json","_c","_b","aiChatStream","onChunk","onDone","onError","buffer","lines","line","trimmed","content","aiStop","SYSTEM_PROMPTS","aiSummarize","aiSuggestTags","aiPolish","aiContinue","aiTranslate","lang","prompt","aiExplain","aiSearchEnhance","getSearchConfig","httpsRequest","httpsGet","searchTavily","apiKey","searchSerper","searchGoogle","cx","searchBocha","webSearch","providers","lastError","provider","registerAIHandlers","event","win","BrowserWindow","text","err","conversationId","title","insert","msg","rowToAttachment","getAttachmentsDir","category","dir","getExtFromFilename","getMimeType","ext","registerAttachmentHandlers","mimeType","width","height","duration","storedName","size","relativePath","absolutePath","shell","properties","result","dialog","fp","fileBuffer","registerDialogHandlers","workspacePath","mdFiles","f","file","registerAllHandlers","__dirname","fileURLToPath","VITE_DEV_SERVER_URL","MAIN_DIST","RENDERER_DIST","createWindow","protocol","request","callback"],"mappings":"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","x_google_ignoreList":[1,2,3,4]}